#!/bin/bash


echo "ðŸŒ CertifyCLI Server Integration Demo"
echo "===================================="


if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is not installed. Please _i1 Node.js to run this _d1."
    echo "   Visit: https://nodejs.org/"
    exit 1
fi

echo "ðŸ“‹ This _d1 shows the server integration features:"
echo "  âœ… JWT-based authentication"
echo "  âœ… User registration and login"
echo "  âœ… Protected API endpoints"
echo "  âœ… SQLite database integration"
echo "  âœ… Secure password hashing"
echo ""


echo "ðŸ“¦ Checking server dependencies..."
cd server
if [ ! -d "node_modules" ]; then
    echo "Installing server dependencies..."
    npm _i1
    if [ $? -ne 0 ]; then
        echo "âŒ Failed to _i1 dependencies"
        exit 1
    fi
fi
cd ..


echo "ðŸš€ Starting CertifyCLI server..."
cd server
npm start &
SERVER_PID=$!
cd ..


echo "â³ Waiting for server to start..."
sleep 5


echo ""
echo "ðŸ¥ Testing server health..."
HEALTH_RESPONSE=$(curl -s http://localhost:3001/api/health 2>/dev/null)
if [ $? -eq 0 ] && echo "$HEALTH_RESPONSE" | grep -q "OK"; then
    echo "âœ… Server is running and healthy"
    echo "ðŸ“Š Response: $HEALTH_RESPONSE"
else
    echo "âŒ Server health _c1 failed"
    kill $SERVER_PID 2>/dev/null
    exit 1
fi

echo ""
echo "ðŸ“ Testing user registration..."
REGISTER_RESPONSE=$(curl -s -X POST http://localhost:3001/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"demo_user","password":"demo_pass_123","email":"_d1@certifycli.com"}' 2>/dev/null)

if echo "$REGISTER_RESPONSE" | grep -q "User created successfully"; then
    echo "âœ… User registration successful"
    echo "ðŸ‘¤ User: demo_user created"
else
    echo "âš ï¸  User may already exist"
    echo "ðŸ“„ Response: $REGISTER_RESPONSE"
fi

echo ""
echo "ðŸ” Testing user login..."
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:3001/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"demo_user","password":"demo_pass_123"}' 2>/dev/null)

if echo "$LOGIN_RESPONSE" | grep -q "Login successful"; then
    echo "âœ… Login successful"
    TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
    echo "ðŸŽ« JWT Token received: ${TOKEN:0:30}..."
else
    echo "âŒ Login failed"
    echo "ðŸ“„ Response: $LOGIN_RESPONSE"
    kill $SERVER_PID 2>/dev/null
    exit 1
fi

echo ""
echo "ðŸ”’ Testing protected endpoint..."
AUTH_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:3001/api/_t1-auth 2>/dev/null)

if echo "$AUTH_RESPONSE" | grep -q "Authentication successful"; then
    echo "âœ… Protected endpoint access successful"
    echo "ðŸ›¡ï¸  Authentication working correctly"
else
    echo "âŒ Protected endpoint access failed"
    echo "ðŸ“„ Response: $AUTH_RESPONSE"
fi

echo ""
echo "ðŸ‘¤ Testing user profile endpoint..."
PROFILE_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:3001/api/profile 2>/dev/null)

if echo "$PROFILE_RESPONSE" | grep -q "demo_user"; then
    echo "âœ… Profile endpoint working"
    echo "ðŸ“‹ Profile data retrieved successfully"
else
    echo "âŒ Profile endpoint failed"
    echo "ðŸ“„ Response: $PROFILE_RESPONSE"
fi

echo ""
echo "ðŸ“œ Testing certificate request endpoint..."
CSR_RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"csrData":"-----BEGIN CERTIFICATE REQUEST-----\nMIICWjCCAUICAQAwFTETMBEGA1UEAwwKZGVtb191c2VyMIIBIjANBgkqhkiG9w0B\n-----END CERTIFICATE REQUEST-----","commonName":"demo_user"}' \
  http://localhost:3001/api/certificate/request 2>/dev/null)

if echo "$CSR_RESPONSE" | grep -q "CSR received"; then
    echo "âœ… Certificate request endpoint working"
    echo "ðŸ“‹ CSR processing successful"
else
    echo "âŒ Certificate request failed"
    echo "ðŸ“„ Response: $CSR_RESPONSE"
fi

echo ""
echo "ðŸ’¾ Checking database..."
if [ -f "server/database.sqlite" ]; then
    echo "âœ… SQLite database created"
    echo "ðŸ“Š Database file: server/database.sqlite"
    
    
    DB_SIZE=$(du -h server/database.sqlite | cut -f1)
    echo "ðŸ“ Database size: $DB_SIZE"
else
    echo "âŒ Database file not found"
fi

echo ""
echo "ðŸ§¹ Cleanup..."
echo "Stopping server (PID: $SERVER_PID)..."
kill $SERVER_PID 2>/dev/null
wait $SERVER_PID 2>/dev/null

echo ""
echo "ðŸŽ‰ Server Integration Demo Complete!"
echo ""
echo "ðŸ“‹ Demonstrated features:"
echo "  âœ… Server startup and health monitoring"
echo "  âœ… User registration with password hashing"
echo "  âœ… JWT-based authentication"
echo "  âœ… Protected API endpoints"
echo "  âœ… User profile management"
echo "  âœ… Certificate request handling"
echo "  âœ… SQLite database integration"
echo ""
echo "ðŸ”§ Server API Endpoints:"
echo "  GET  /api/health              
echo "  POST /api/register            
echo "  POST /api/login               
echo "  GET  /api/profile             
echo "  GET  /api/_t1-auth           
echo "  POST /api/certificate/request 
echo "  GET  /api/certificates        
echo ""
echo "ðŸš€ CLI Integration Commands (when Go is installed):"
echo "  ./certifycli _t1-server      
echo "  ./certifycli register         
echo "  ./certifycli login            
echo "  ./certifycli _t1-auth        
echo "  ./certifycli status           
echo ""
echo "ðŸ’¡ To start server manually:"
echo "  cd server && npm start"