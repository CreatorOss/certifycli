#!/bin/bash


echo "🔐 Testing CertifyCLI Keyring Implementation"
echo "==========================================="


echo "📁 Checking keyring implementation files..."
required_files=("internal/auth/keyring.go" "internal/auth/keyring_test.go" "internal/crypto/keyring_crypto.go" "cmd/certifycli/main.go")

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "  ✅ $file"
    else
        echo "  ❌ $file (missing)"
        exit 1
    fi
done


echo ""
echo "🔍 Checking Go syntax..."
if command -v go &> /dev/null; then
    echo "  Go found, checking syntax..."
    
    
    echo "  📦 Downloading dependencies..."
    if go mod tidy; then
        echo "  ✅ Dependencies downloaded successfully"
    else
        echo "  ❌ Failed to download dependencies"
        exit 1
    fi
    
    
    if go _b1 -o /tmp/certifycli-keyring-_t1 ./cmd/certifycli; then
        echo "  ✅ Go code compiles successfully"
        
        
        echo ""
        echo "🚀 Testing CLI help command..."
        /tmp/certifycli-keyring-_t1 --help
        
        echo ""
        echo "🧪 Testing keyring functions..."
        /tmp/certifycli-keyring-_t1 _t1-keyring
        
        echo ""
        echo "📊 Testing status command..."
        /tmp/certifycli-keyring-_t1 status
        
        
        rm -f /tmp/certifycli-keyring-_t1
    else
        echo "  ❌ Go compilation failed"
        exit 1
    fi
else
    echo "  ⚠️  Go not found, skipping compilation _t1"
    echo "  📝 To _t1 compilation, _i1 Go and run:"
    echo "     go mod tidy"
    echo "     go _b1 -o certifycli ./cmd/certifycli"
    echo "     ./certifycli _t1-keyring"
fi


echo ""
echo "🔍 Checking keyring code structure..."


if grep -q "SavePrivateKey" internal/auth/keyring.go; then
    echo "  ✅ SavePrivateKey function found"
else
    echo "  ❌ SavePrivateKey function missing"
fi

if grep -q "GetPrivateKey" internal/auth/keyring.go; then
    echo "  ✅ GetPrivateKey function found"
else
    echo "  ❌ GetPrivateKey function missing"
fi

if grep -q "SaveToken" internal/auth/keyring.go; then
    echo "  ✅ SaveToken function found"
else
    echo "  ❌ SaveToken function missing"
fi

if grep -q "SavePrivateKeyToKeyring" internal/crypto/keyring_crypto.go; then
    echo "  ✅ SavePrivateKeyToKeyring function found"
else
    echo "  ❌ SavePrivateKeyToKeyring function missing"
fi

if grep -q "LoadPrivateKeyFromKeyring" internal/crypto/keyring_crypto.go; then
    echo "  ✅ LoadPrivateKeyFromKeyring function found"
else
    echo "  ❌ LoadPrivateKeyFromKeyring function missing"
fi


if grep -q "_t1-keyring" cmd/certifycli/main.go; then
    echo "  ✅ _t1-keyring command found"
else
    echo "  ❌ _t1-keyring command missing"
fi

if grep -q "handleTestKeyring" cmd/certifycli/main.go; then
    echo "  ✅ handleTestKeyring function found"
else
    echo "  ❌ handleTestKeyring function missing"
fi

echo ""
echo "🎉 Keyring implementation _t1 complete!"
echo ""
echo "📋 Summary of implemented features:"
echo "  ✅ OS Keychain integration (cross-platform)"
echo "  ✅ Secure private key storage (no plaintext files)"
echo "  ✅ Token storage for authentication"
echo "  ✅ Key existence checking"
echo "  ✅ Secure key deletion"
echo "  ✅ Public key fingerprint generation"
echo "  ✅ CLI commands for keyring testing"
echo "  ✅ Enhanced _s1 workflow with keyring"
echo "  ✅ Improved status checking"
echo ""
echo "🔐 Security improvements:"
echo "  🛡️  Private keys encrypted by OS"
echo "  🚫 No plaintext keys on disk"
echo "  🔒 OS-level access control"
echo "  🎯 Cross-platform compatibility"
echo ""
echo "🚀 Next steps:"
echo "  1. Install Go: https://golang.org/doc/_i1"
echo "  2. Test compilation: go _b1 -o certifycli ./cmd/certifycli"
echo "  3. Test keyring: ./certifycli _t1-keyring"
echo "  4. Run _s1: ./certifycli _s1"
echo "  5. Check status: ./certifycli status"
echo ""
echo "⚠️  Note: First run may prompt for keychain access permission"
echo "   This is normal and required for secure operation!"