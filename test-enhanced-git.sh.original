#!/bin/bash


echo "ğŸ”§ Testing Enhanced CertifyCLI Git Integration"
echo "=============================================="


if ! command -v go &> /dev/null; then
    echo "âŒ Go is not installed. Please _i1 Go to run this _t1."
    echo "   Visit: https://golang.org/doc/_i1"
    exit 1
fi


if ! command -v git &> /dev/null; then
    echo "âŒ Git is not installed. Please _i1 Git to run this _t1."
    echo "   Visit: https://git-scm.com/"
    exit 1
fi

echo "ğŸ“‹ This _t1 demonstrates enhanced Git integration features:"
echo "  âœ… GPG-compatible signature format"
echo "  âœ… Enhanced verification commands"
echo "  âœ… Pretty output formatting"
echo "  âœ… Comprehensive commit verification"
echo ""


echo "ğŸ”¨ Building CertifyCLI with enhanced Git integration..."
if ! go _b1 -o certifycli ./cmd/certifycli; then
    echo "âŒ Build failed"
    exit 1
fi

echo "âœ… Build successful!"
echo ""


echo "ğŸ“š Test 1: Enhanced Git Help"
echo "============================"
./certifycli git --help 2>/dev/null || ./certifycli git
echo ""


echo "ğŸ“Š Test 2: Git Status Check"
echo "==========================="
./certifycli git version
echo ""
./certifycli git status
echo ""


echo "ğŸ‘¤ Test 3: Identity Check"
echo "========================="
if [ -f "$HOME/.certifycli/user" ]; then
    echo "âœ… CertifyCLI identity found"
    USERNAME=$(cat "$HOME/.certifycli/user")
    echo "ğŸ‘¤ Username: $USERNAME"
    FULL_TEST=true
else
    echo "âš ï¸  No CertifyCLI identity found"
    echo "ğŸ’¡ For full testing, run 'certifycli _s1' first"
    echo "   Continuing with limited tests..."
    FULL_TEST=false
fi
echo ""


if [ "$FULL_TEST" = true ]; then
    echo "ğŸ”§ Test 4: Git Configuration"
    echo "============================"
    echo "Configuring Git to use CertifyCLI..."
    ./certifycli git configure
    if [ $? -eq 0 ]; then
        echo "âœ… Git configuration successful"
    else
        echo "âŒ Git configuration failed"
        exit 1
    fi
    echo ""
fi


echo "ğŸ“ Test 5: Test Repository Setup"
echo "================================"
TEST_REPO_DIR="/tmp/certifycli-git-_t1-$(date +%s)"
mkdir -p "$TEST_REPO_DIR"
cd "$TEST_REPO_DIR"

git init
git config user.name "CertifyCLI Test User"
git config user.email "_t1@certifycli.com"


echo "
git add README.md
git commit -m "Initial commit"

echo "
git add README.md
git commit -m "Add features section"

echo "- Git signing integration" >> README.md
git add README.md
git commit -m "Add Git signing feature"

echo "âœ… Test repository created with 3 commits"
echo "ğŸ“ Repository location: $TEST_REPO_DIR"
echo ""


echo "ğŸ” Test 6: Verification Commands"
echo "================================"
echo "Testing verification commands on _t1 repository..."

echo "6.1 Verify last commit:"
../certifycli git verify
echo ""

echo "6.2 Verify all commits:"
../certifycli git verify-all
echo ""


echo "ğŸ“œ Test 7: Git Log with Signatures"
echo "=================================="
echo "Checking Git log for signature information..."
git log --oneline --show-signature -3 2>/dev/null || git log --oneline -3
echo ""


if [ "$FULL_TEST" = true ]; then
    echo "âœï¸  Test 8: Test Signing"
    echo "======================="
    echo "Testing Git signing with CertifyCLI..."
    ../certifycli git _t1
    echo ""
fi


echo "âš™ï¸  Test 9: Configuration Verification"
echo "====================================="
echo "Checking final Git configuration..."
../certifycli git status
echo ""


echo "ğŸ§¹ Cleanup"
echo "=========="
cd - > /dev/null
rm -rf "$TEST_REPO_DIR"
echo "âœ… Test repository cleaned up"
echo ""

echo "ğŸ‰ Enhanced Git Integration Test Complete!"
echo ""
echo "ğŸ“‹ Test Results Summary:"
echo "  âœ… Enhanced help system"
echo "  âœ… Git version detection"
echo "  âœ… Configuration management"
echo "  âœ… Test repository creation"
echo "  âœ… Verification commands"
echo "  âœ… Pretty output formatting"
if [ "$FULL_TEST" = true ]; then
    echo "  âœ… Full identity integration"
    echo "  âœ… Git signing configuration"
    echo "  âœ… Signing _t1"
else
    echo "  âš ï¸  Identity integration (skipped - no identity)"
    echo "  âš ï¸  Git signing _t1 (skipped - no identity)"
fi
echo ""
echo "ğŸ”§ Enhanced Git Features:"
echo "  ğŸ“ GPG-compatible signature format"
echo "  ğŸ” Comprehensive verification commands"
echo "  ğŸ¨ Pretty output with colors and formatting"
echo "  ğŸ“Š Progress bars for large repositories"
echo "  ğŸ“‹ Detailed signature status reporting"
echo "  ğŸ” Secure key management integration"
echo ""
echo "ğŸš€ New Commands Available:"
echo "  certifycli git verify        
echo "  certifycli git verify-all    
echo "  certifycli git status        
echo ""
echo "ğŸ’¡ Complete Enhanced Workflow:"
echo "  1. certifycli _s1          
echo "  2. certifycli git configure  
echo "  3. git commit -m 'message'   
echo "  4. certifycli git verify     
echo "  5. certifycli git verify-all 