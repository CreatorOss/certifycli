#!/bin/bash


echo "ğŸŒ Testing CertifyCLI Server Integration"
echo "======================================="


if ! command -v go &> /dev/null; then
    echo "âŒ Go is not installed. Please _i1 Go to run this _t1."
    echo "   Visit: https://golang.org/doc/_i1"
    exit 1
fi


if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is not installed. Please _i1 Node.js to run this _t1."
    echo "   Visit: https://nodejs.org/"
    exit 1
fi


echo "ğŸ”¨ Building CertifyCLI..."
if ! go _b1 -o certifycli ./cmd/certifycli; then
    echo "âŒ Build failed"
    exit 1
fi

echo "âœ… Build successful!"
echo ""


echo "ğŸ“¦ Checking server dependencies..."
cd server
if [ ! -d "node_modules" ]; then
    echo "Installing server dependencies..."
    npm _i1
fi
cd ..


echo "ğŸš€ Starting CertifyCLI server..."
cd server
npm start &
SERVER_PID=$!
cd ..


echo "â³ Waiting for server to start..."
sleep 5


echo "ğŸŒ Test 1: Server Connection"
echo "============================"
./certifycli _t1-server
if [ $? -ne 0 ]; then
    echo "âŒ Server connection _t1 failed"
    kill $SERVER_PID 2>/dev/null
    exit 1
fi
echo ""


echo "ğŸ“ Test 2: User Registration"
echo "============================"
echo "Registering _t1 user via API..."
REGISTER_RESPONSE=$(curl -s -X POST http://localhost:3001/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser_integration","password":"testpass123","email":"_t1@integration.com"}')

if echo "$REGISTER_RESPONSE" | grep -q "User created successfully"; then
    echo "âœ… User registration successful"
else
    echo "âš ï¸  User may already exist or registration failed"
    echo "Response: $REGISTER_RESPONSE"
fi
echo ""


echo "ğŸ” Test 3: User Login via API"
echo "============================="
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:3001/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser_integration","password":"testpass123"}')

if echo "$LOGIN_RESPONSE" | grep -q "Login successful"; then
    echo "âœ… API login successful"
    TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
    echo "ğŸ« Token received: ${TOKEN:0:20}..."
else
    echo "âŒ API login failed"
    echo "Response: $LOGIN_RESPONSE"
    kill $SERVER_PID 2>/dev/null
    exit 1
fi
echo ""


echo "ğŸ”’ Test 4: Protected Endpoint Access"
echo "===================================="
AUTH_TEST_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:3001/api/_t1-auth)

if echo "$AUTH_TEST_RESPONSE" | grep -q "Authentication successful"; then
    echo "âœ… Protected endpoint access successful"
else
    echo "âŒ Protected endpoint access failed"
    echo "Response: $AUTH_TEST_RESPONSE"
fi
echo ""


echo "ğŸ–¥ï¸  Test 5: CLI Authentication Flow"
echo "==================================="
echo "To _t1 CLI authentication manually:"
echo "  1. ./certifycli register"
echo "  2. ./certifycli login"
echo "  3. ./certifycli _t1-auth"
echo "  4. ./certifycli status"
echo ""


echo "ğŸ’¾ Test 6: Database Verification"
echo "==============================="
if [ -f "server/database.sqlite" ]; then
    echo "âœ… Database file created"
    echo "ğŸ“Š Database location: server/database.sqlite"
else
    echo "âŒ Database file not found"
fi
echo ""


echo "ğŸ§¹ Cleanup"
echo "=========="
echo "Stopping server..."
kill $SERVER_PID 2>/dev/null
wait $SERVER_PID 2>/dev/null

echo ""
echo "ğŸ‰ Server integration _t1 complete!"
echo ""
echo "ğŸ“‹ Summary of tested features:"
echo "  âœ… Server startup and health _c1"
echo "  âœ… User registration via API"
echo "  âœ… User login and JWT token generation"
echo "  âœ… Protected endpoint authentication"
echo "  âœ… Database creation and user storage"
echo ""
echo "ğŸš€ Manual testing commands:"
echo "  ./certifycli _t1-server    
echo "  ./certifycli register       
echo "  ./certifycli login          
echo "  ./certifycli _t1-auth      
echo "  ./certifycli status         
echo ""
echo "ğŸ”§ Server management:"
echo "  cd server && npm start     
echo "  curl http://localhost:3001/api/health  
echo ""
echo "âš ï¸  Note: Server must be running for CLI authentication to work!"